!function(){"use strict";const e="mirakl tag",t=`🚨 ${e} error: `,r=`⚠️ ${e} warning: `,n=`✅ ${e} : `,o=e=>{console.error(`${t}${e}`)},a=e=>{console.warn(`${r}${e}`)},i={home:[1e3,1199],product:[1200,1399],list:[1400,1599],cart:[1600,1799],content:[2200,2399],postPayment:[2400,2599],login:[2600,2799],account_creation_start:[2800,2999],account_creation_end:[3e3,3199],purchase_begin:[3200,3399],search_results_empty:[3400,3599],not_found:[3600,3799]},s=["home","content","login","account_creation_start","account_creation_end","purchase_begin","search_results_empty","not_found"],d=(e,t)=>{const r="number"==typeof e?e:+e;return!Number.isNaN(r)&&(r>=i[t][0]&&r<=i[t][1])},c=e=>{const t=l(e);return void 0!==t&&""!==t},l=e=>window._t2sparams?.[e],u=[{validatorFunction:()=>!!window._t2sparams,errorMessage:"_t2sparams global variable must be defined before using any T2S method."},{validatorFunction:()=>c("cID"),errorMessage:"cID field must be defined on _t2sparams object before using any T2S method."},{validatorFunction:()=>c("pID"),errorMessage:"pID field must be defined on _t2sparams object before using any T2S method."},{validatorFunction:()=>!d(l("pID"),"list")||c("aID"),errorMessage:"aID field should be provided when pID correspond to a list page.",optional:!0},{validatorFunction:()=>!d(l("pID"),"cart")||c("bS"),errorMessage:"bS field should be provided when pID correspond to a cart page.",optional:!0},{validatorFunction:()=>{return e=l("pID"),!!s.some((t=>d(e,t)))||(d(l("pID"),"postPayment")||c("iID"));var e},errorMessage:"iID field is missing or null so there is no product in the page's context. Please note that this type of context is required for the following page types: product page, shopping cart, list / category, post-payment, search results (not empty); More generally, all page where one or several products are displayed.",optional:!0},{validatorFunction:()=>!d(l("pID"),"postPayment")||c("oID"),errorMessage:"oID field should be provided when pID correspond to a post payment page.",optional:!0},{validatorFunction:()=>{return!l("domain")||(e=l("domain"),new RegExp(/^((www\.)?)(?!-)([\dA-Za-z-]+)*([\dA-Za-z]([\dA-Za-z-]*[\dA-Za-z])?)*(\.[\dA-Za-z]([\dA-Za-z-]*[\dA-Za-z])?)*\.[A-Za-z]{2,}$/).test(e));var e},errorMessage:"domain field must be a valid domain name before using any T2S method."}],p=()=>u.every((e=>{if(e.validatorFunction())return!0;return(e.optional?a:o)(e.errorMessage),e.optional})),m=e=>{if("video-player"===e)return((e,t)=>{const r="mirakl-video-player-script";return document.getElementById(r)&&t?Promise.resolve({id:r,alreadyLoaded:!0}):document.getElementById(r)&&!t?new Promise((e=>{document.getElementById(r).addEventListener("load",(()=>{e({id:r,alreadyLoaded:!0})}))})):new Promise((t=>{const n=document.createElement("script");n.src=`https://static.target2sell.com/${e}`,n.async=!0,n.id=r,n.addEventListener("load",(()=>{t({id:r,alreadyLoaded:!1})}));const o=document.getElementsByTagName("script")[0];o?o.parentNode.insertBefore(n,o):document.head.append(n)}))})("t2s.video-player.min.js",window.playMiraklAdsVideo)},w=e=>document.cookie.split(`${e}=`)[1]?.split(";")[0],g=()=>"https:"===document.location.protocol,h=()=>""+(window?._t2sparams?.domain?`Domain=${window._t2sparams.domain}`:""),_=(e,t,{expire:r}={})=>{document.cookie=`${e}=${t}; Path=/; Expires=${r?.toUTCString()??(()=>{const e=Date.now();return new Date(e+33696e6).toUTCString()})()};  ${g()?"Secure; SameSite=None":""}; ${h()}`},y=e=>{document.cookie=`${e}= ; expires=Thu, 01 Jan 1970 00:00:01 GMT; ${g()?"Secure; SameSite=None":""}; ${h()}`},f="t2s-analytics",v=()=>(w(f)||_(f,(()=>{let e=Date.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replaceAll(/[xy]/g,(t=>{const r=Math.trunc((e+16*Math.random())%16);return e=Math.floor(e/16),("x"==t?r:7&r|8).toString(16)}))})()),_("t2s-p",w(f)),w(f)),b=async(e,t,r)=>{try{const n=await window.fetch(e+(e=>{const t=e?.queryParameters??{},r=new URLSearchParams;for(const e of Object.keys(t))r.append(e,t[e]?.toString());return e?.invalidateCache&&r.append("tmst",Date.now().toString()),r.toString()?`?${r.toString()}`:""})(r),{method:t,headers:r?.headers,body:r?.body}),o=await n.json();return r?.onSuccess?.(o),o}catch(e){throw r?.onError?.(e),e}},I=(e,t)=>b(e,"POST",t),S="t2s-personalisation",k=()=>window.t2sConsiderUserConsent,x=()=>{if(!k())return!0;return"true"===w(S)},T=(e,t)=>{const r=new URL(e);return new URLSearchParams(r.search).get(t)||void 0},D=(e,t=[])=>Object.keys(e).reduce(((r,n)=>{const o=e[n];if(t.includes(n)||!o||["function","boolean"].includes(typeof o))return r;if("object"==typeof o)r[n]=o;else try{r[n]=JSON.parse(o.toString())}catch{r[n]=o.toString()}return r}),{}),C=()=>D({...window._t2sparams,tID:v(),userConsent:x().toString(),rF:document.referrer,cURL:window.location.href,uEM:l("uEM")?.toString()??T(window.location.href,"t2suEM"),trace:l("trace")?.toString()??T(window.location.href,"trace")??sessionStorage.getItem("t2sTrace")}),E="t2s-rank",$=()=>{const e=9e5+Date.now();return new Date(e)},P=async e=>{const t=w(E);if(t)return t;try{const t=`https://api.target2sell.com/user/indexes/${v()}`,{rank:r}=await((e,t)=>b(e,"GET",t))(t,{headers:{"t2s-customer-id":e},invalidateCache:!0});return _(E,r,{expire:$()}),r}catch{return y(E)}},M={publisher_id:"string",user_mail:"string",cookie_id:"string",url:"string",basket_products:"string",page_id:"string",domain:"string",lang:"string",set_id:"string",wish_list:"string",keywords:"string",product_ids:"string",category_id:"string",page_number:"string",basket_amount:"string",products_quantity:"number",order_id:"string",price_list:"string",has_rank_option:"boolean",trace:"string",event_name:"string",ad_id:"string"},j=["has_rank_option"],O=e=>e in M,N={event_name:"eN",cookie_id:"tID",publisher_id:"cID",page_id:"pID",category_id:"aID",referer:"rF",url:"cURL",product_ids:"iID",products_quantity:"qTE",set_id:"setID",basket_amount:"bS",basket_products:"bP",order_id:"oID",user_mail:"uEM",encoded_user_id:"userId",user_id:"uID",space:"sp",rule:"ru",position:"po",destination:"dES",keywords:"kW",query:"q",trace:"trace",trace_token:"traceToken",callstack:"callstack",no_event:"noEvent",shuffle:"shuffle",non_contextual:"nonContextual",price_list:"priceL",ab_display:"abDisplay",lang:"lang",user_rank:"userRank",crm_prefix:"crm_",crm_key_value_map:"crm",page_number:"pageNbr",wish_list:"wl",constraint:"constraint",media_rule_id:"mediaRuleId",media_campaign_id:"mediaCampaignId",media_type:"mediaType",media_algo:"mediaAlgo",max_product:"maxProduct",domain:"domain",tracking_id:"trackingId",embedded_structure:"embeddedStructure",render:"render",no_timeout:"noTimeout",formats:"formats",visual_search_img:"visualSearchImage",visual_search_object:"visualSearchObject",user_consent:"userConsent",multisets:"setL",add_to_cart_product:"addToCartProductId",product_id:"productId",ad_id:"adId",view_id:"viewId",offer_id:"offerID",progress:"progress",has_rank_option:"hasRankOption"},U=Object.fromEntries(Object.entries(N).map((([e,t])=>[t,e]))),R=e=>Object.entries(e).reduce(((e,[t,r])=>t in U?{...e,[U[t]]:r}:{...e,[t]:r}),{}),L=async e=>{const t=e.has_rank_option&&await P(`${e.publisher_id}`),r={...(n=e,o=j,Object.keys(n).reduce(((e,t)=>o.includes(t)?e:{...e,[t]:n[t]}),{})),cookie_id:v(),...document.referrer&&{referer:document.referrer},user_consent:x().toString(),url:window.location.href,user_mail:e.user_mail??T(window.location.href,"t2suEM"),trace:e.trace??T(window.location.href,"trace")??sessionStorage.getItem("t2sTrace"),...t&&{user_rank:t}};var n,o;const a=(i=r,Object.entries(i).reduce(((e,[t,r])=>t in N?{...e,[N[t]]:r}:{...e,[t]:r}),{}));var i,s;return Promise.resolve(new URLSearchParams((s=a,Object.entries(s).reduce(((e,[t,r])=>r?{...e,[t]:r.toString()}:e),{}))).toString())},A=async(e,t,r=!0,n=!1)=>{r&&(e=>{if(!e||0===Object.keys(e).length)throw new Error("No parameters provided");for(const[t,r]of Object.entries(e))O(t)?typeof r!==M[t]&&o(`Invalid type for parameter ${t}: expected ${M[t]}, got ${typeof r}`):t.startsWith("crm_")||a(`Unknown parameter: ${t}`)})({...t,...window._miraklTagParameters});const i=await L({...t,...window._miraklTagParameters,event_name:e});return I("https://serv-api.target2sell.com/1.1/json/T/t",{invalidateCache:!0,headers:{"Content-Type":"application/x-www-form-urlencoded"},body:i}).catch((e=>{if(n)throw e;o(e.message)}))},q=async(e,t,r=!0)=>{const n=await A("click",t,r);return e&&(window.location.href=e),n},F=async(e,t)=>{const r={...C(),...D({eN:e,userRank:l("hasRankOption")?await P(`${l("cID")}`):void 0}),...D(t,["redir"])};return new URLSearchParams(r).toString()},z=()=>(async(e,t,r)=>{if(p())try{await I("https://serv-api.target2sell.com/1.1/json/T/t",{invalidateCache:!0,headers:{"Content-Type":"application/x-www-form-urlencoded"},body:await F(e,t||{}),onSuccess:r}),t?.redir&&(window.location.href=t.redir)}catch(e){o(e.message)}})(""),B=async(e,t={},r)=>{if(!e||"string"!=typeof e)return o("you must provide a valid event name string when calling event method");if(!p())return;const{redir:n,...a}=t??{},i=R({...a,...window._t2sparams});return A(e,i,!1).then((e=>(r&&r(e),n&&(window.location.href=n),e)))},V={threshold:[.25,.5,.75,1]},Z=(e,t)=>{let r;const n=new IntersectionObserver((t=>{const o=t[0],a=o.target.attributes.getNamedItem(`data-${e}`)?.value;if(a)return new Promise((e=>{o.intersectionRatio>=.5?r?e():r=setTimeout((()=>{B("viewableImpression",{viewId:a}).then((()=>{n.unobserve(o.target),r=void 0,e()}))}),1e3):(r&&(clearTimeout(r),r=void 0),e())}))}),V),o=document.querySelector(`[data-${e}="${t}"]`);o&&n.observe(o)},J=async(e,t)=>{if(!p())return;const r=`https://reco.target2sell.com/product/v2/${l("cID")}/render`;try{await I(r,{invalidateCache:!0,headers:{"Content-Type":"application/json"},body:JSON.stringify({...C(),...D(e||{},["redir"])}),onSuccess:r=>{(e=>{for(const[t,r]of Object.entries(e)){const e=document.getElementById(t);e&&r&&(e.innerHTML=r)}})(r.spaces),t?.(r),sessionStorage.setItem("t2sRecoCalled","true"),e?.redir&&(window.location.href=e.redir)}})}catch(e){o(e.message)}},W="t2s_wl";sessionStorage.setItem("t2sRecoCalled","false"),B("view");const G={considerUserConsent:e=>void 0===e?o("considerUserConsent parameter is required"):"boolean"!=typeof e?o("considerUserConsent parameter must be a valid boolean"):(window.t2sConsiderUserConsent=e,window.t2sConsiderUserConsent),userConsentsToT2S:e=>{const t=k();return void 0===t?(o("considerUserConsent must be called at least once before userConsentsToT2S call"),!1):"boolean"!=typeof e?(o("considerUserConsent must be called with a valid boolean value"),!1):(t&&_(S,e?"true":"false"),e)},event:B,click:async(e,t)=>{const{redir:r,...n}=e,o=R({...n,...window._t2sparams});return q(r,o,!1).then((e=>(t&&t(e),e)))},inspire:async(e,t)=>{if(p())try{await I("https://reco.target2sell.com/content/v3",{invalidateCache:!0,headers:{"Content-Type":"application/json"},queryParameters:{render:!0},body:JSON.stringify({...C(),...D(e||{},["redir"])}),onSuccess:r=>{(e=>{for(const t of e){const e=document.getElementById(`${l("cID")}-${t.id}`);e&&t.html&&(e.innerHTML=t.html)}})(r.spaces),t?.(r),e?.redir&&(window.location.href=e?.redir)}})}catch(e){o(e.message)}},reco:J,addToCart:e=>void 0===e?.productId?o("you must provide a valid productId when calling addToCart method."):(e?.trackingId&&B("click",{iID:e.productId,trackingId:e.trackingId}),B("addToCart",e)),recordShopInteraction:(e,t)=>(({interactionType:e,setExternalId:t})=>{if(!l("cID"))return o("_t2sparams.cID must be set before calling recordShopInteraction.");const r=T(window.location.href,"localize"),n="UNKNOWN"===l("uEM")?void 0:l("uEM");return I("https://serv-api.target2sell.com/user/v1/recordShopInteraction",{headers:{"Content-Type":"application/json"},body:JSON.stringify({customerPublicId:l("cID"),interactionType:!t&&r?"LIVE_EXPLICIT_DECISION":e,setExternalId:t??r??l("setId"),tID:v(),uEM:T(window.location.href,"t2suEM")??n??null})})})({interactionType:e,setExternalId:t}),clickProductInWhishlist:(e,t)=>{const r=w(W)??"",n=r.includes(e)?r.split("|").filter((t=>t!==e)):[...r.split("|"),e];n.length>0?_(W,n.filter(Boolean).join("|")):y(W),t?.()},checkCustomerConfig:()=>{var e;p()&&(e="_t2sparams global object is valid.",console.info(`${n}${e}`))},watchViewability:(e="mirakl-view-id")=>{const t=document.querySelectorAll(`[data-${e}]`),r=Array.from(t).map((t=>t.attributes.getNamedItem(`data-${e}`).value));for(const t of r)Z(e,t)},writeParams:new Promise(((e,t)=>{window._t2sparams&&e(window._t2sparams),t("no params")})),playVideo:async(...e)=>(await m("video-player"),window.playMiraklAdsVideo(...e)),_sendTracking:()=>z(),_sendTrackingWithRank:()=>z(),_sendReco:()=>J(),version:"3.1.1"};window.T2S=G,window.miraklAds={fetchAds:async e=>{const{customerId:t,...r}=e;return I("https://api.eu1.retailmedia.mirakl.net/ads/v1/public",{invalidateCache:!0,headers:{"Content-Type":"application/json","x-customer-id":t,"x-current-timestamp":Date.now().toString()},body:JSON.stringify({...r,userId:v(),userConsent:x()})})}},window.miraklTag={click:q,event:A},window.dispatchEvent(new Event("t2sReady")),window._miraklVideoPlayers&&window._miraklVideoPlayers.forEach((({rootElement:e,adId:t,videoUrl:r,settings:n})=>{window.T2S.playVideo(e,t,r,n)}))}();
